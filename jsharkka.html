<!DOCTYPE html>
<html lang="en">
<head>

<title>R3 DEMO</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="index.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

</head>
<body>

<div class="container">
<div id="root"></div>
</div>

<script type="text/babel">

const INIT_PAYMENT_DATA = true;

class App extends React.Component {
	constructor(props) {
		super(props);
		this.state = this.initState();
		this.addPayment = this.addPayment.bind(this);
		this.removePayment = this.removePayment.bind(this);
	}

	initState() { 																				//sovelluksen alustus
		let state = {paymentData: []};
		if (INIT_PAYMENT_DATA) {
			const PAYMENT_COUNT = 10;
			const FROM_COUNT = 2;
			const TO_COUNT = 10;
			const SUM_MIN = 10;
			const SUM_MAX = 50;
			for (let i = 0; i < PAYMENT_COUNT; i++) { 											//for-loopilla lisätään randomisti generoituja maksuja kymmenen kappaletta
				let payment_from = `Henkilö ${String.fromCharCode(Math.floor(Math.random() * FROM_COUNT) + 65)}`; 
				let payment_to = `Yritys ${String.fromCharCode(Math.floor(Math.random() * TO_COUNT) + 65)}`;
				let payment_date = "dd.mm.yyyy";
				let payment_sum = parseFloat((Math.random() * (SUM_MAX - SUM_MIN) + SUM_MIN).toFixed(2));
				state.paymentData.push({from: payment_from, to: payment_to, date: payment_date, sum: payment_sum, id: i});
			}
		}

		return state;
	}

	addPayment(newPayment) { 																	//lisätään maksu listaan
		this.setState({paymentData: [...this.state.paymentData, newPayment]});
	}

	removePayment(id) { 																		//poistetaan maksu listasta
		this.setState({
			paymentData: this.state.paymentData.filter((payment) => {
				return payment.id != id;
			})
		});
	}

	render() { 																					//näyttää koodin ulostulon
		return (
			<div>
				<PaymentInput addPayment={this.addPayment} />
				<PaymentSummary paymentData={this.state.paymentData} />
				{this.state.paymentData.length > 0 &&
					<table className="table">
					<colgroup>
						<col id="columnTo" />
						<col id="columnDate" />
						<col id="columnSum" />
						<col id="columnFrom" />
						<col id="columnControls" />
					</colgroup>
					<PaymentsHead />
					<PaymentsBody paymentData={this.state.paymentData} removePayment={this.removePayment} />
					</table>
				}
			</div>
		);
	}
}

class PaymentInput extends React.Component { 			//luokka, jossa luodaan maksun syötettävän tiedon kentät
	constructor(props) {
		super(props);
		this.emptyState = {from: "", to: "", date: "", sum: "", id: ""};
		this.state = this.emptyState;
		this.handleChange = this.handleChange.bind(this);
		this.handleSubmit = this.handleSubmit.bind(this);
	}

	handleChange(event) { 
		this.setState({[event.target.name]: event.target.value});
	}

	handleSubmit(event) { 					//käsittelee "lisää"-napilla syötetyt tiedot 
		if (this.isValidPayment()) {
			this.state.from = this.state.from.trim();
			this.state.to = this.state.to.trim();
			this.state.date = this.state.date.trim();
			this.state.sum = parseFloat(this.state.sum.replace(",", "."));
			this.state.id = Date.now();

			this.props.addPayment(this.state);
			this.setState(this.emptyState);
		}
		event.preventDefault();
	}

	isValidPayment() { 					//tarkistetaan, että syöttökentissä on oikeamuotoiset arvot
		return this.isValidName(this.state.from) && this.isValidName(this.state.to) && this.isValidDate(this.state.date) && this.isValidSum(this.state.sum);
	}

	isValidDate(date) { 					//tarkistaa päivämäärän
		return date.trim() !== "";
	}

	isValidName(name) { 					//tarkistaa nimen
		return name.trim() !== "";
	}

	isValidSum(sum) { 					//tarkistaa summan
		return !isNaN(parseFloat(sum.replace(",", ".")));
	}

	render() { 						//syötekentät
		return (
			<form className="mt-3" onSubmit={this.handleSubmit}>
				<div className="form-row align-items-end">
					<div className="form-group col-lg-4"><label className="col-form-label" htmlFor="inputTo">Laskuttava yritys</label><input type="text" name="to" value={this.state.to} className="form-control" id="inputTo" onChange={this.handleChange} /></div>
					<div className="form-group col-lg-2"><label className="col-form-label" htmlFor="inputDate">Maksupäivämäärä</label><input type="text" name="date" value={this.state.date} className="form-control" id="inputDate" onChange={this.handleChange} /></div>
					<div className="form-group col-lg-1"><label className="col-form-label" htmlFor="inputSum">Summa</label><input type="text" name="sum" value={this.state.sum} className="form-control" id="inputSum" onChange={this.handleChange} /></div>
					<div className="form-group col-lg-4"><label className="col-form-label" htmlFor="inputFrom">Laskun maksaja</label><input type="text" name="from" value={this.state.from} className="form-control" id="inputFrom" onChange={this.handleChange} /></div>
					<div className="form-group col-lg-1">{this.isValidPayment() && <button type="submit" className="btn btn-primary btn-block">Lisää</button>}</div>
				</div>
			</form>
		);
	}
}

function PaymentSummary(props) {								//funktio, joka laskee maksujen summan
	let sums = {};
	props.paymentData.forEach(function(payment) {
		if (payment.from in sums) {
			sums[payment.from] += payment.sum;
		} else {
			sums[payment.from] = payment.sum;
		}
	});
	let names = Object.keys(sums);
	if (names.length < 2) {
		return null;
	} else if (names.length > 2) {
		return ( 												//virheenkäsittely jos on enemmän maksjia
			<div className="alert alert-warning">
			<h1>Maksajia on useampi kuin kaksi.</h1>
			</div>
		);
	} else {
		let diffCurrency, diffValue, summary;
		diffValue = sums[names[0]] - sums[names[1]];
		if (diffValue < 0) {
			diffValue = -diffValue;
			diffCurrency = diffValue.toLocaleString("fi-FI", {style: "currency", currency: "EUR"});
			summary = `${names[0]} maksaa ${diffCurrency}.`;
		} else if (diffValue > 0) {
			diffCurrency = diffValue.toLocaleString("fi-FI", {style: "currency", currency: "EUR"});
			summary = `${names[1]} maksaa ${diffCurrency}.`;
		} else {
			summary = "Laskut menivät tasan.";
		}
		return ( 												//palauttaa tekstin joka on summan lopputulos
			<div className="alert alert-dark">
			<h1>{summary}</h1>
			</div>
		);
	}
}

                                                                //funktio taulukon sisällölle
function PaymentsBody(props) { 									
	const rows = props.paymentData.map((row) => {
		return (
			<tr key={row.id}>
				<td>{row.to}</td> 								
				<td>{row.date}</td> 							
				<td className="cellSum">{row.sum.toLocaleString("fi-FI", {style: "currency", currency: "EUR"})}</td> 
				<td>{row.from}</td> 							
				<td><button className="btn btn-outline-danger btn-sm" onClick={props.removePayment.bind(null,row.id)}>Poista</button></td> 
			</tr>
		);
	});
	return <tbody>{rows}</tbody>;
}
function PaymentsHead(props) { 									//funktio otsikkoriville
	return (
		<thead className="thead-dark">
			<tr>
				<th scope="col">Laskuttaja</th>
				<th scope="col">Maksupäivämäärä</th>
				<th scope="col">Loppusumma</th>
				<th scope="col">Maksaja</th>
				<th scope="col"></th>
			</tr>
		</thead>
	);
}
ReactDOM.render(<App />, document.getElementById("root"));



</script>

<!-- https://getbootstrap.com/docs/4.4/getting-started/introduction/#js -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</body>
</html>
